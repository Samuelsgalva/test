<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumen de GestiÃ³n</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h2 { color: #1f2937; margin-bottom: 20px; font-size: 20px; }
    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea { resize: vertical; min-height: 100px; }
    button {
      background: #1f7aec;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    button:hover { background: #1d6fd8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .info-panel {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
      transition: all 0.3s ease;
    }
    .info-panel.success { background: #d1fae5; border-color: #6ee7b7; color: #065f46; }
    .info-panel.warning { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
    .toast {
      background: #d1fae5;
      border: 1px solid #6ee7b7;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .blocked-overlay {
      display: none;
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }
    .blocked-overlay .icon { font-size: 48px; margin-bottom: 16px; }
    .blocked-overlay p { font-size: 15px; line-height: 1.5; }
    .blocked-overlay .inbox-id {
      display: inline-block;
      margin-top: 8px;
      padding: 2px 8px;
      background: #f3f4f6;
      border-radius: 4px;
      font-family: monospace;
      font-size: 13px;
      color: #374151;
    }
    body.is-blocked .app-content { display: none; }
    body.is-blocked .blocked-overlay { display: block; }
    .debug {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 11px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Blocked state -->
    <div class="blocked-overlay" id="blockedOverlay">
      <div class="icon">ğŸ”’</div>
      <p>Esta aplicaciÃ³n no estÃ¡ disponible para esta bandeja de entrada.</p>
      <span class="inbox-id" id="blockedInboxId"></span>
    </div>

    <!-- App content -->
    <div class="app-content">
      <h2>Resumen de GestiÃ³n</h2>

      <div class="info-panel" id="conversationInfo">
        â³ Esperando contexto de Chatwootâ€¦
      </div>

      <form id="summaryForm">
        <div class="form-group">
          <label for="resultado">Resultado</label>
          <select id="resultado" required>
            <option value="">Seleccionarâ€¦</option>
            <option value="resuelto">Resuelto</option>
            <option value="pendiente">Pendiente</option>
            <option value="escalado">Escalado</option>
            <option value="sin_respuesta">Sin respuesta</option>
          </select>
        </div>

        <div class="form-group">
          <label for="categoria">CategorÃ­a</label>
          <select id="categoria" required>
            <option value="">Seleccionarâ€¦</option>
            <option value="soporte_tecnico">Soporte tÃ©cnico</option>
            <option value="ventas">Ventas</option>
            <option value="consulta">Consulta</option>
            <option value="reclamo">Reclamo</option>
            <option value="otro">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="resumen">Resumen</label>
          <textarea id="resumen" placeholder="Describe brevemente la gestiÃ³n realizadaâ€¦" required></textarea>
        </div>

        <div class="form-group">
          <label for="notas">Notas adicionales</label>
          <textarea id="notas" placeholder="InformaciÃ³n adicional (opcional)"></textarea>
        </div>

        <button type="submit" id="submitBtn">Guardar resumen</button>
      </form>

      <div class="toast" id="successMsg">âœ“ Resumen guardado correctamente</div>
    </div>

    <!-- Debug â€” eliminar en producciÃ³n -->
    <div class="debug" id="debugPanel"></div>
  </div>

  <script src="chatwoot-context.js"></script>

  <script>
    // â”€â”€ ConfiguraciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ALLOWED_INBOX_IDS = [2]; // â† Solo inbox 2

    const ctx = new ChatwootContext({
      debug: true,
      debugPanelId: 'debugPanel',
      timeoutMs: 5000,
      allowedInboxIds: ALLOWED_INBOX_IDS,
    });

    // â”€â”€ Elementos DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const $info           = document.getElementById('conversationInfo');
    const $form           = document.getElementById('summaryForm');
    const $submitBtn      = document.getElementById('submitBtn');
    const $successMsg     = document.getElementById('successMsg');
    const $blockedInboxId = document.getElementById('blockedInboxId');

    // â”€â”€ Renderizar info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderInfo({ conversation, contact, agent, team }) {
      $info.className = 'info-panel success';
      $info.innerHTML = `
        <strong>ConversaciÃ³n:</strong> #${conversation.id ?? 'N/A'}<br>
        <strong>Cliente:</strong> ${contact.name}<br>
        <strong>TelÃ©fono:</strong> ${contact.phoneNumber}<br>
        <strong>Email:</strong> ${contact.email}<br>
        <strong>Estado:</strong> ${conversation.status}<br>
        <strong>Canal:</strong> ${conversation.channel}<br>
        <strong>Inbox:</strong> #${conversation.inboxId ?? 'N/A'}<br>
        <strong>Equipo:</strong> ${team.name}<br>
        <strong>Agente:</strong> ${agent.name}
      `;
    }

    // â”€â”€ Eventos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx
      .on('contextReady', (models) => {
        document.body.classList.remove('is-blocked');
        renderInfo(models);
      })
      .on('contextUpdated', (models) => {
        document.body.classList.remove('is-blocked');
        renderInfo(models);
      })
      .on('inboxBlocked', ({ inboxId, allowedIds }) => {
        document.body.classList.add('is-blocked');
        $blockedInboxId.textContent =
          `Inbox actual: #${inboxId} â€” Permitidos: ${allowedIds.map(id => '#' + id).join(', ')}`;
      })
      .on('contextTimeout', () => {
        $info.className = 'info-panel warning';
        $info.innerHTML = 'âš ï¸ No se recibiÃ³ contexto. Verifica la configuraciÃ³n de Dashboard App.';
      });

    // â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $form.addEventListener('submit', async (e) => {
      e.preventDefault();

      $submitBtn.disabled = true;
      $submitBtn.textContent = 'Guardandoâ€¦';

      const conv  = ctx.conversation;
      const ctc   = ctx.contact;
      const agent = ctx.agent;
      const team  = ctx.team;

      const summary = {
        conversation_id: conv?.id ?? 'N/A',
        inbox_id:        conv?.inboxId ?? 'N/A',
        resultado:       document.getElementById('resultado').value,
        categoria:       document.getElementById('categoria').value,
        resumen:         document.getElementById('resumen').value,
        notas:           document.getElementById('notas').value,
        timestamp:       new Date().toISOString(),
        agent:           agent?.name ?? 'N/A',
        agent_email:     agent?.email ?? 'N/A',
        cliente:         ctc?.name ?? 'N/A',
        telefono:        ctc?.phoneNumber ?? 'N/A',
        email_cliente:   ctc?.email ?? 'N/A',
        team:            team?.name ?? 'N/A',
        channel:         conv?.channel ?? 'N/A',
        status:          conv?.status ?? 'N/A',
      };

      console.log('Resumen generado:', summary);

      // await fetch('https://tu-api.com/api/save-summary', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(summary),
      // });

      $successMsg.style.display = 'block';

      setTimeout(() => {
        $form.reset();
        $successMsg.style.display = 'none';
        $submitBtn.disabled = false;
        $submitBtn.textContent = 'Guardar resumen';
      }, 2000);
    });

    // â”€â”€ Arrancar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.init();
  </script>
</body>
</html>