<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resumen de Gestión</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h2 { color: #1f2937; margin-bottom: 20px; font-size: 20px; }
    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      margin-bottom: 6px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea { resize: vertical; min-height: 100px; }
    button {
      background: #1f7aec;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    button:hover { background: #1d6fd8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .info-panel {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
      transition: all 0.3s ease;
    }
    .info-panel.success { background: #d1fae5; border-color: #6ee7b7; color: #065f46; }
    .info-panel.warning { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
    .toast {
      background: #d1fae5;
      border: 1px solid #6ee7b7;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-top: 16px;
      display: none;
    }
    .debug {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 11px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Resumen de Gestión</h2>

    <div class="info-panel" id="conversationInfo">
      ⏳ Esperando contexto de Chatwoot…
    </div>

    <form id="summaryForm">
      <div class="form-group">
        <label for="resultado">Resultado</label>
        <select id="resultado" required>
          <option value="">Seleccionar…</option>
          <option value="resuelto">Resuelto</option>
          <option value="pendiente">Pendiente</option>
          <option value="escalado">Escalado</option>
          <option value="sin_respuesta">Sin respuesta</option>
        </select>
      </div>

      <div class="form-group">
        <label for="categoria">Categoría</label>
        <select id="categoria" required>
          <option value="">Seleccionar…</option>
          <option value="soporte_tecnico">Soporte técnico</option>
          <option value="ventas">Ventas</option>
          <option value="consulta">Consulta</option>
          <option value="reclamo">Reclamo</option>
          <option value="otro">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="resumen">Resumen</label>
        <textarea id="resumen" placeholder="Describe brevemente la gestión realizada…" required></textarea>
      </div>

      <div class="form-group">
        <label for="notas">Notas adicionales</label>
        <textarea id="notas" placeholder="Información adicional (opcional)"></textarea>
      </div>

      <button type="submit" id="submitBtn">Guardar resumen</button>
    </form>

    <div class="toast" id="successMsg">✓ Resumen guardado correctamente</div>

    <!-- Panel de debug — eliminar en producción -->
    <div class="debug" id="debugPanel"></div>
  </div>

  <!-- ① Cargar el módulo reutilizable de contexto -->
  <script src="chatwoot-context.js"></script>

  <!-- ② Lógica específica de ESTA dashboard app -->
  <script>
    // ── Inicializar contexto de Chatwoot ─────
    const ctx = new ChatwootContext({
      debug: true,               // poner false en producción
      debugPanelId: 'debugPanel',
      timeoutMs: 5000,
    });

    // ── Elementos DOM ────────────────────────
    const $info       = document.getElementById('conversationInfo');
    const $form       = document.getElementById('summaryForm');
    const $submitBtn  = document.getElementById('submitBtn');
    const $successMsg = document.getElementById('successMsg');

    // ── Renderizar info de la conversación ───
    function renderInfo({ conversation, contact, agent }) {
      $info.className = 'info-panel success';
      $info.innerHTML = `
        <strong>Conversación:</strong> #${conversation.id ?? 'N/A'}<br>
        <strong>Cliente:</strong> ${contact.name}<br>
        <strong>Teléfono:</strong> ${contact.phoneNumber}<br>
        <strong>Email:</strong> ${contact.email}<br>
        <strong>Estado:</strong> ${conversation.status}<br>
        <strong>Canal:</strong> ${conversation.channel}<br>
        <strong>Agente:</strong> ${agent.name}
      `;
    }

    // ── Eventos del contexto ─────────────────
    ctx
      .on('contextReady', (models) => {
        renderInfo(models);
      })
      .on('contextUpdated', (models) => {
        renderInfo(models);
      })
      .on('contextTimeout', () => {
        $info.className = 'info-panel warning';
        $info.innerHTML = '⚠️ No se recibió contexto. Verifica que esta app esté configurada como Dashboard App en Chatwoot.';
      });

    // ── Envío del formulario ─────────────────
    $form.addEventListener('submit', async (e) => {
      e.preventDefault();

      $submitBtn.disabled = true;
      $submitBtn.textContent = 'Guardando…';

      const conv  = ctx.conversation;
      const ctc   = ctx.contact;
      const agent = ctx.agent;

      const summary = {
        conversation_id: conv?.id ?? 'N/A',
        resultado:       document.getElementById('resultado').value,
        categoria:       document.getElementById('categoria').value,
        resumen:         document.getElementById('resumen').value,
        notas:           document.getElementById('notas').value,
        timestamp:       new Date().toISOString(),
        agent:           agent?.name ?? 'N/A',
        agent_email:     agent?.email ?? 'N/A',
        cliente:         ctc?.name ?? 'N/A',
        telefono:        ctc?.phoneNumber ?? 'N/A',
        email_cliente:   ctc?.email ?? 'N/A',
        channel:         conv?.channel ?? 'N/A',
        status:          conv?.status ?? 'N/A',
      };

      console.log('Resumen generado:', summary);

      // ─── Enviar a tu backend ───────────────
      // try {
      //   await fetch('https://tu-api.com/api/save-summary', {
      //     method: 'POST',
      //     headers: { 'Content-Type': 'application/json' },
      //     body: JSON.stringify(summary),
      //   });
      // } catch (err) {
      //   console.error('Error al enviar:', err);
      // }
      // ───────────────────────────────────────

      // Mostrar éxito y resetear
      $successMsg.style.display = 'block';

      setTimeout(() => {
        $form.reset();
        $successMsg.style.display = 'none';
        $submitBtn.disabled = false;
        $submitBtn.textContent = 'Guardar resumen';
      }, 2000);
    });

    // ── Arrancar ─────────────────────────────
    ctx.init();
  </script>
</body>
</html>